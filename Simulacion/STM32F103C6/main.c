/* Main.c file generated by New Project wizard
 *
 * Created:   Tue Jan 18 2022
 * Processor: STM32F103C6
 * Compiler:  Keil for ARM
 */

#include <stm32f103x6.h>
#include <spi_config.h>
#include <max7219.h>
#include <stdlib.h>
#include <delay.h>
#include <definitions.h>
#include <fsm.h>
#include <buttons.h>
#include <seos.h>

void SysTick_Handler(void)
{
    seos_task_scheduler();
}

int main (void)
{ 
// Write your code here

      uint8_t led_matrix[BOARD_SIZE][BOARD_SIZE] = {
                        {0},
                        {0},
                        {0},
                        {0},
                        {0},
                        {0},
                        {0},
                        {0},
      };
      int button;

      spi_init();
      max7219_init();
      buttons_init();
      fsm_state_selector(NOP, led_matrix);
      fsm_state_selector(NOP, led_matrix);
      max7219_load(led_matrix);
      max7219_refresh();

      SysTick_Config(SYS_FREQUENCY / 1000);


      while (1)
      {
            if(seos_get_flag(BUTTON_SCANNING))
            {
                  seos_clear_flag(BUTTON_SCANNING);
                  button = button_press();
            }
            if(seos_get_flag(MATRIX_REFRESH))
            {
                  seos_clear_flag(MATRIX_REFRESH);
                  max7219_load(led_matrix);
                  max7219_refresh();
            }
            if (seos_get_flag(STATE_MACHINE))
            {
                  seos_clear_flag(STATE_MACHINE);
                  fsm_state_selector(button, led_matrix);
            }
      }
}   
